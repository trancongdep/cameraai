<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VDC Safety AI v1.23</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
    <style>
        :root { --primary: #2563eb; --danger: #ef4444; --success: #22c55e; --bg: #0f172a; }
        body { font-family: -apple-system, system-ui, sans-serif; margin: 0; background: var(--bg); color: white; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Loading Screen */
        #loading-screen { position: fixed; inset: 0; background: var(--bg); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 50px; height: 50px; border: 5px solid #1e293b; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* App Interface */
        .app-header { padding: 15px; text-align: center; font-weight: bold; background: #1e293b; border-bottom: 1px solid #334155; }
        #viewer-container { flex: 1; position: relative; background: #000; display: flex; align-items: center; justify-content: center; }
        video, #result-canvas { width: 100%; height: 100%; object-fit: contain; }
        #result-canvas { display: none; position: absolute; top: 0; left: 0; z-index: 10; }

        .controls { padding: 25px; background: #1e293b; border-top: 1px solid #334155; display: flex; flex-direction: column; align-items: center; }
        .btn-capture { width: 70px; height: 70px; border-radius: 50%; border: 4px solid white; background: var(--danger); box-shadow: 0 0 15px rgba(0,0,0,0.5); cursor: pointer; transition: 0.2s; }
        .btn-capture:active { transform: scale(0.9); }
        .btn-capture:disabled { filter: grayscale(1); cursor: not-allowed; }
        
        #status-text { margin-top: 15px; font-size: 14px; font-weight: 500; }
        .violation-text { color: var(--danger); font-weight: bold; animation: blink 0.6s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    </style>
</head>
<body>

<div id="loading-screen">
    <div class="spinner"></div>
    <p style="margin-top: 20px;">Đang nạp mô hình VDC AI...</p>
    <small style="color: #64748b;">ppe.dat (83.3MB)</small>
</div>

<div class="app-header">VDC SAFETY AI v1.23</div>

<div id="viewer-container">
    <video id="webcam" autoplay playsinline muted></video>
    <canvas id="result-canvas"></canvas>
    <canvas id="process-canvas" width="640" height="640" style="display:none;"></canvas>
</div>

<div class="controls">
    <button id="capture-btn" class="btn-capture" title="Chụp và phân tích"></button>
    <div id="status-text">Sẵn sàng chụp ảnh</div>
    <audio id="beep" src="https://www.soundjay.com/buttons/beep-01a.mp3"></audio>
</div>

<script>
    // Nhãn thực tế
    const labels = ["Đã đội nón", "Khẩu trang", "CHƯA ĐỘI NÓN", "Không khẩu trang", "Không áo phản quang", "Nhân viên", "Cọc tiêu", "Áo phản quang", "Máy móc", "Phương tiện"];
    
    const video = document.getElementById('webcam');
    const resCanvas = document.getElementById('result-canvas');
    const procCanvas = document.getElementById('process-canvas');
    const btn = document.getElementById('capture-btn');
    const stt = document.getElementById('status-text');
    const loading = document.getElementById('loading-screen');
    const beep = document.getElementById('beep');
    let session;

    async function initApp() {
        try {
            // Nạp mô hình
            session = await ort.InferenceSession.create('./ppe.dat', { executionProviders: ['wasm'] });
            
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment" } 
            });
            video.srcObject = stream;
            
            loading.style.display = 'none';
        } catch (e) {
            alert("Lỗi khởi động: " + e.message);
        }
    }

    btn.onclick = async () => {
        btn.disabled = true;
        stt.innerText = "ĐANG PHÂN TÍCH...";
        
        // 1. Chụp ảnh vào Canvas xử lý
        const pCtx = procCanvas.getContext('2d');
        pCtx.drawImage(video, 0, 0, 640, 640);
        
        // Hiển thị ảnh tĩnh lên màn hình chính
        const rCtx = resCanvas.getContext('2d');
        resCanvas.width = video.videoWidth;
        resCanvas.height = video.videoHeight;
        rCtx.drawImage(video, 0, 0, resCanvas.width, resCanvas.height);
        resCanvas.style.display = 'block';

        // 2. Chạy AI Inference
        const imgData = pCtx.getImageData(0, 0, 640, 640);
        const input = new Float32Array(1 * 3 * 640 * 640);
        for (let i = 0; i < 640 * 640; i++) {
            input[i] = imgData.data[i * 4] / 255.0;
            input[i + 640*640] = imgData.data[i * 4 + 1] / 255.0;
            input[i + 2*640*640] = imgData.data[i * 4 + 2] / 255.0;
        }
        
        const tensor = new ort.Tensor('float32', input, [1, 3, 640, 640]);
        const outputs = await session.run({ images: tensor });
        const output = outputs[Object.keys(outputs)[0]].data;

        // 3. Xử lý kết quả & Hiển thị
        let violationCount = 0;
        for (let i = 0; i < output.length; i += 6) {
            const conf = output[i + 4];
            const cls = output[i + 5];
            if (conf > 0.45 && cls === 2) { // ID 2: CHƯA ĐỘI NÓN
                violationCount++;
            }
        }

        if (violationCount > 0) {
            stt.innerHTML = `<span class="violation-text">PHÁT HIỆN ${violationCount} TRƯỜNG HỢP VI PHẠM!</span>`;
            beep.play();
        } else {
            stt.innerHTML = `<span style="color:var(--success)">AN TOÀN - ĐÃ ĐỘI NÓN</span>`;
        }

        // Đợi 4 giây để xem kết quả rồi quay lại Camera
        setTimeout(() => {
            resCanvas.style.display = 'none';
            stt.innerText = "Sẵn sàng chụp ảnh";
            btn.disabled = false;
        }, 4000);
    };

    initApp();
</script>
</body>
</html>

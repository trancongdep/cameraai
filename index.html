<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="manifest" href="./manifest.json">
    <title>VDC Safety AI v1.33</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
    <style>
        :root { --blue: #2563eb; --red: #dc2626; --slate: #0f172a; --green: #22c55e; }
        body { font-family: sans-serif; margin: 0; background: var(--slate); color: white; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        #loader { position: fixed; inset: 0; background: var(--slate); z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spin { width: 35px; height: 35px; border: 4px solid #1e293b; border-top-color: var(--blue); border-radius: 50%; animation: s 1s linear infinite; }
        @keyframes s { to { transform: rotate(360deg); } }
        header { padding: 12px; background: #1e293b; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #334155; }
        #view-area { position: relative; flex: 1; background: #000; display: flex; align-items: center; justify-content: center; }
        video, #photo-out { width: 100%; height: 100%; object-fit: contain; position: absolute; }
        #photo-out { display: none; z-index: 10; }
        .controls { position: absolute; bottom: 0; width: 100%; padding: 25px 0 45px 0; background: linear-gradient(transparent, rgba(15, 23, 42, 0.95)); display: flex; flex-direction: column; align-items: center; z-index: 20; }
        .shutter-btn { width: 75px; height: 75px; border-radius: 50%; border: 6px solid white; background: var(--red); cursor: pointer; }
        #save-panel { display: none; position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); width: 85%; background: #1e293b; padding: 20px; border-radius: 12px; z-index: 100; box-shadow: 0 10px 40px #000; border: 1px solid var(--blue); }
        #save-panel input { width: 100%; padding: 12px; margin: 15px 0; border-radius: 6px; border: 1px solid #334155; background: #0f172a; color: white; box-sizing: border-box; font-size: 16px; }
        #history-panel { display: none; position: fixed; inset: 0; background: var(--slate); z-index: 1001; overflow-y: auto; padding: 20px; }
        .hist-item { background: #1e293b; margin-bottom: 15px; border-radius: 8px; overflow: hidden; border: 1px solid #334155; }
        .hist-item img { width: 100%; height: auto; }
        .btn { padding: 12px; border-radius: 6px; border: none; font-weight: bold; flex: 1; cursor: pointer; }
    </style>
</head>
<body>

<div id="loader"><div class="spin"></div><p>Đang nạp AI HSE...</p></div>

<header>
    <span>VDC SAFETY v1.33</span>
    <button onclick="showHistory()" style="background:var(--blue); border:none; color:#fff; padding:6px 12px; border-radius:4px; font-weight:bold;">LỊCH SỬ</button>
</header>

<div id="view-area">
    <video id="webcam" autoplay playsinline muted></video>
    <canvas id="photo-out"></canvas>
    <canvas id="proc-canvas" width="320" height="320" style="display:none;"></canvas>
</div>

<div class="controls">
    <div id="status" style="margin-bottom:15px; font-weight:bold; text-shadow: 2px 2px 4px #000; font-size:18px;">QUÉT AN TOÀN</div>
    <button id="cap-btn" class="shutter-btn"></button>
</div>

<div id="save-panel">
    <h3 style="margin-top:0; color:var(--red);">VI PHẠM AN TOÀN</h3>
    <input type="text" id="note-input" value="">
    <div style="display:flex; gap:10px;">
        <button class="btn" style="background:#475569; color:white;" onclick="closeSave()">HỦY</button>
        <button class="btn" style="background:var(--blue); color:white;" onclick="confirmSave()">LƯU LẠI</button>
    </div>
</div>

<div id="history-panel">
    <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center;">
        <h2>Lịch sử vi phạm</h2>
        <button onclick="closeHistory()" style="background:var(--red); color:white; border:none; padding:10px 20px; border-radius:6px; font-weight:bold;">ĐÓNG</button>
    </div>
    <div id="history-list"></div>
</div>

<script>
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');

    const video = document.getElementById('webcam');
    const photoOut = document.getElementById('photo-out');
    const procCanvas = document.getElementById('proc-canvas');
    const btn = document.getElementById('cap-btn');
    const stt = document.getElementById('status');
    const savePanel = document.getElementById('save-panel');
    const noteInput = document.getElementById('note-input');
    const loader = document.getElementById('loader');
    let session, lastImg = null;

    async function init() {
        try {
            session = await ort.InferenceSession.create('./ppe.dat', { executionProviders: ['wasm'] });
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            video.srcObject = stream;
            loader.style.display = 'none';
        } catch (e) { alert("Lỗi nạp AI: " + e.message); }
    }

    btn.onclick = async () => {
        btn.disabled = true;
        stt.innerText = "ĐANG PHÂN TÍCH...";
        
        const ctx = photoOut.getContext('2d');
        photoOut.width = video.videoWidth; 
        photoOut.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        photoOut.style.display = 'block';

        const prCtx = procCanvas.getContext('2d');
        prCtx.drawImage(video, 0, 0, 320, 320);

        setTimeout(async () => {
            try {
                const img = prCtx.getImageData(0, 0, 320, 320);
                const input = new Float32Array(3 * 320 * 320);
                for (let i = 0; i < 320 * 320; i++) {
                    input[i] = img.data[i*4] / 255.0;
                    input[i+102400] = img.data[i*4+1] / 255.0;
                    input[i+204800] = img.data[i*4+2] / 255.0;
                }

                const res = await session.run({ images: new ort.Tensor('float32', input, [1,3,320,320]) });
                const data = res[Object.keys(res)[0]].data;

                let detected = [];
                let errLog = [];

                for (let i = 0; i < data.length; i += 6) {
                    const conf = data[i+4];
                    const cls = Math.round(data[i+5]);
                    
                    // Xử lý nới lỏng ngưỡng tin cậy riêng cho NÓN
                    // Giả định Class ID: 2: No Helmet, 4: No Vest, 10: No Shoes
                    let label = "";
                    if (cls === 2 && conf > 0.20) label = "THIẾU NÓN";
                    else if (cls === 4 && conf > 0.30) label = "THIẾU ÁO";
                    else if (cls === 10 && conf > 0.30) label = "THIẾU GIÀY";
                    else if (cls === 3 && conf > 0.30) label = "THIẾU KHẨU TRANG";

                    if (label) {
                        detected.push({ box: [data[i], data[i+1], data[i+2], data[i+3]], label: label });
                        if(!errLog.includes(label)) errLog.push(label);
                    }
                }

                if (detected.length > 0) {
                    stt.innerHTML = `<span style="color:var(--red)">PHÁT HIỆN VI PHẠM!</span>`;
                    ctx.strokeStyle = "red"; ctx.lineWidth = 5;
                    ctx.font = "bold 18px sans-serif"; ctx.fillStyle = "red";
                    
                    detected.forEach(v => {
                        const b = v.box;
                        const x = (b[0] / 320) * photoOut.width;
                        const y = (b[1] / 320) * photoOut.height;
                        const w = (b[2] / 320) * photoOut.width - x;
                        const h = (b[3] / 320) * photoOut.height - y;
                        ctx.strokeRect(x, y, w, h);
                        ctx.fillText(v.label, x, y - 10);
                    });

                    lastImg = photoOut.toDataURL("image/jpeg", 0.6);
                    noteInput.value = errLog.join(", ");
                    savePanel.style.display = 'block';
                } else {
                    stt.innerHTML = "<span style='color:var(--green)'>AN TOÀN</span>";
                    setTimeout(() => { photoOut.style.display = 'none'; btn.disabled = false; stt.innerText = "QUÉT AN TOÀN"; }, 1500);
                }
            } catch (err) { stt.innerText = "Lỗi xử lý"; btn.disabled = false; }
        }, 100);
    };

    function closeSave() { savePanel.style.display = 'none'; photoOut.style.display = 'none'; btn.disabled = false; stt.innerText = "QUÉT AN TOÀN"; }

    function confirmSave() {
        const hist = JSON.parse(localStorage.getItem('vdc_v4') || '[]');
        hist.unshift({ img: lastImg, note: noteInput.value, date: new Date().toLocaleString() });
        localStorage.setItem('vdc_v4', JSON.stringify(hist.slice(0, 30)));
        closeSave();
    }

    function showHistory() {
        const list = document.getElementById('history-list');
        const hist = JSON.parse(localStorage.getItem('vdc_v4') || '[]');
        list.innerHTML = hist.length ? '' : '<p style="text-align:center">Chưa có dữ liệu.</p>';
        hist.forEach(item => {
            list.innerHTML += `<div class="hist-item"><img src="${item.img}"><div style="padding:15px"><b>${item.date}</b><br>${item.note}</div></div>`;
        });
        document.getElementById('history-panel').style.display = 'block';
    }

    function closeHistory() { document.getElementById('history-panel').style.display = 'none'; }

    init();
</script>
</body>
</html>

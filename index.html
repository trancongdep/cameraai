<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VDC Safety AI v1.24</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
    <style>
        :root { --blue: #2563eb; --red: #dc2626; --slate: #0f172a; }
        body { font-family: -apple-system, sans-serif; margin: 0; background: var(--slate); color: white; height: 100vh; display: flex; flex-direction: column; }
        
        /* Màn hình nạp mô hình */
        #loader { position: fixed; inset: 0; background: var(--slate); z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spin { width: 40px; height: 40px; border: 4px solid #1e293b; border-top-color: var(--blue); border-radius: 50%; animation: s 1s linear infinite; }
        @keyframes s { to { transform: rotate(360deg); } }

        /* Giao diện chính */
        header { padding: 15px; background: #1e293b; text-align: center; font-weight: bold; font-size: 14px; border-bottom: 1px solid #334155; }
        #view { flex: 1; position: relative; background: #000; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        video, #preview { width: 100%; height: 100%; object-fit: cover; }
        #preview { display: none; position: absolute; top: 0; left: 0; z-index: 10; }

        .controls { padding: 30px; background: #1e293b; display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .shutter { width: 75px; height: 75px; border-radius: 50%; border: 5px solid white; background: var(--red); cursor: pointer; display: block; }
        .shutter:disabled { opacity: 0.3; filter: grayscale(1); }
        
        #stt { font-size: 15px; font-weight: 500; height: 20px; }
        .warn { color: #ff4444; animation: blink 0.5s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div id="loader">
    <div class="spin"></div>
    <p id="load-msg" style="margin-top: 20px;">Đang chuẩn bị AI...</p>
</div>

<header>VDC SAFETY AI - v1.24</header>

<div id="view">
    <video id="webcam" autoplay playsinline muted></video>
    <canvas id="preview"></canvas>
    <canvas id="hidden-canvas" width="640" height="640" style="display:none;"></canvas>
</div>

<div class="controls">
    <div id="stt">Mô hình đã lưu vào máy</div>
    <button id="btn" class="shutter"></button>
    <audio id="beep" src="https://www.soundjay.com/buttons/beep-01a.mp3"></audio>
</div>

<script>
    const labels = ["Đã đội nón", "Khẩu trang", "CHƯA ĐỘI NÓN", "Không khẩu trang", "Không áo phản quang", "Nhân viên", "Cọc tiêu", "Áo phản quang", "Máy móc", "Phương tiện"];
    const video = document.getElementById('webcam');
    const preview = document.getElementById('preview');
    const hCanvas = document.getElementById('hidden-canvas');
    const btn = document.getElementById('btn');
    const stt = document.getElementById('stt');
    const loader = document.getElementById('loader');
    const beep = document.getElementById('beep');
    let session;

    async function initPWA() {
        try {
            // Cơ chế lưu mô hình vào Cache để tải 1 lần duy nhất
            const cache = await caches.open('vdc-ai-cache');
            let response = await cache.match('./ppe.dat');
            
            if (!response) {
                document.getElementById('load-msg').innerText = "Tải mô hình lần đầu (83MB)...";
                await cache.add('./ppe.dat');
                response = await cache.match('./ppe.dat');
            }

            const modelData = await response.arrayBuffer();
            session = await ort.InferenceSession.create(modelData, { executionProviders: ['wasm'] });
            
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            video.srcObject = stream;
            
            loader.style.display = 'none';
        } catch (e) { alert("Lỗi nạp PWA: " + e.message); }
    }

    btn.onclick = async () => {
        btn.disabled = true;
        stt.innerText = "ĐANG PHÂN TÍCH...";
        
        // Chụp ảnh
        const hCtx = hCanvas.getContext('2d');
        hCtx.drawImage(video, 0, 0, 640, 640);
        
        // Hiện ảnh tĩnh
        const pCtx = preview.getContext('2d');
        preview.width = video.videoWidth; preview.height = video.videoHeight;
        pCtx.drawImage(video, 0, 0, preview.width, preview.height);
        preview.style.display = 'block';

        // Xử lý AI
        const img = hCtx.getImageData(0, 0, 640, 640);
        const input = new Float32Array(3 * 640 * 640);
        for (let i = 0; i < 640 * 640; i++) {
            input[i] = img.data[i*4]/255.0;
            input[i+640*640] = img.data[i*4+1]/255.0;
            input[i+2*640*640] = img.data[i*4+2]/255.0;
        }

        const out = await session.run({ images: new ort.Tensor('float32', input, [1,3,640,640]) });
        const res = out[Object.keys(out)[0]].data;

        let detected = 0;
        for (let i = 0; i < res.length; i += 6) {
            if (res[i+4] > 0.45 && res[i+5] === 2) detected++;
        }

        if (detected > 0) {
            stt.innerHTML = `<span class="warn">CẢNH BÁO: ${detected} NGƯỜI CHƯA ĐỘI NÓN!</span>`;
            beep.play();
        } else {
            stt.innerText = "AN TOÀN - ĐÃ ĐỘI NÓN";
        }

        setTimeout(() => {
            preview.style.display = 'none';
            stt.innerText = "Sẵn sàng kiểm tra";
            btn.disabled = false;
        }, 4000);
    };

    initPWA();
</script>
</body>
</html>
